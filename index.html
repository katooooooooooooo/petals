<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="style.css" />
  <title>Petalk ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    body { font-family: system-ui,-apple-system,"Hiragino Kaku Gothic ProN",sans-serif; line-height:1.6; padding:1rem; }
    .controls{ display:flex; gap:.5rem; align-items:center; margin:.5rem 0 0; }
    .msg{ position:relative; margin:6px 0; border-top:1px solid #eee; padding:12px 14px; white-space:pre-wrap; border-radius:12px; }
    .system{ color:#555; font-style:italic; background:#f6f6f6; padding:8px 10px; border-radius:6px; }
    #send[disabled]{ opacity:.6; cursor:not-allowed; }
    .muted{ color:#666; font-size:.9em; }
    /* å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆå„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å³ä¸Šï¼‰ */
    .msg .del-btn{
      position:absolute; top:6px; right:8px; border:0; background:transparent; cursor:pointer;
      color:#9aa0a6; font-size:14px; padding:2px 4px; border-radius:6px;
    }
    .msg .del-btn:hover{ color:#ef4444; background:rgba(239,68,68,.08); }
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="logo">ğŸ¾</div>
    <h1>Petalk ãƒãƒ£ãƒƒãƒˆã¸ã‚ˆã†ã“ã</h1>
  </div>
  <div id="status" class="muted">ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªä¸­...</div>
  <nav style="margin:8px 0 16px">
    <a href="pets.html">ãƒšãƒƒãƒˆæƒ…å ±</a>
    <a href="auth.html">ãƒ­ã‚°ã‚¤ãƒ³/æ–°è¦ç™»éŒ²</a>
  </nav>

  <div class="card">
    <h2>ãƒšãƒƒãƒˆã«é–¢ã™ã‚‹è³ªå•</h2>
    <div class="input-row">
      <input type="text" id="message" placeholder="ãƒšãƒƒãƒˆã®ç›¸è«‡ã‚’ã—ã¦ã¿ã¦ã­" />
      <button class="btn" id="send">é€ä¿¡</button>
    </div>

    <div class="controls">
      <span id="visibleHint" class="muted">è¡¨ç¤º: æœ€æ–°10ä»¶</span>
      <button class="btn secondary" id="toggleView">ã‚‚ã£ã¨è¦‹ã‚‹</button>
      <button class="btn secondary" id="clearLogs">å±¥æ­´ã‚’å…¨å‰Šé™¤</button>
    </div>

    <div id="chat-log"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getDatabase, ref, onValue, update, remove,
    push, set, serverTimestamp, query, limitToLast
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // ---- Firebase ----
  const firebaseConfig = {
    apiKey: "AIzaSyD_Vt5U_OKXP1LOepSdsjpPUzs1FlKh3tE",
    authDomain: "petalk-a70e1.firebaseapp.com",
    databaseURL: "https://petalk-a70e1-default-rtdb.firebaseio.com",
    projectId: "petalk-a70e1"
  };
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getDatabase(app);

  // ---- çŠ¶æ…‹ç®¡ç† ----
  let user = null;
  let petInfoText = "ï¼ˆãƒšãƒƒãƒˆæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
  let petsMap = {};
  let recentTurns = [];     // AIç”¨: ç›´è¿‘8ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  let lastItemsCache = [];  // è¡¨ç¤ºç”¨ï¼ˆidå«ã‚€ï¼‰
  let showAll = false;      // false=10ä»¶, true=50ä»¶
  const VISIBLE_MIN = 10, VISIBLE_MAX = 50;

  // ğŸ”¸ è¡¨ç¤ºç”¨ã«æœ«å°¾ã® UPDATE è¡Œã ã‘ã‚’é™¤å»
  function stripUpdateFromText(text){
    return text.replace(/UPDATE:\s*\{[\s\S]*\}\s*$/,'').trim();
  }

  // ===== ä¼šè©±ãƒ­ã‚° ä¿å­˜ =====
  async function saveLog(role, text) {
    if (!user) return;
    try {
      const logRef = push(ref(db, `users/${user.uid}/logs`));
      await set(logRef, { role, text, createdAt: serverTimestamp() });
    } catch (e) { console.error("[saveLog]", e); }
  }

  // ===== å€‹åˆ¥å‰Šé™¤ / å…¨å‰Šé™¤ =====
  async function deleteLog(logId) {
    if (!user || !logId) return;
    const ok = confirm("ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
    if (!ok) return;
    try {
      await remove(ref(db, `users/${user.uid}/logs/${logId}`));
    } catch (e) {
      console.error("[deleteLog]", e);
      alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  }

  async function clearAllLogs() {
    if (!user) return;
    const ok = confirm("ä¼šè©±å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if (!ok) return;
    try {
      await remove(ref(db, `users/${user.uid}/logs`));
    } catch (e) {
      console.error("[clearAllLogs]", e);
      alert("å…¨å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  }

  // ===== ä¼šè©±ãƒ­ã‚° è³¼èª­ =====
  function subscribeLogs() {
    if (!user) return;
    const qRef = query(ref(db, `users/${user.uid}/logs`), limitToLast(200));
    onValue(qRef, (snap) => {
      const items = [];
      snap.forEach((child) => {
        const v = child.val() || {};
        const ts = typeof v.createdAt === "number"
          ? v.createdAt
          : (v.createdAt?.seconds ? v.createdAt.seconds * 1000 : 0);
        items.push({ id: child.key, role: v.role, text: v.text ?? "", createdAt: ts });
      });
      items.sort((a,b)=>a.createdAt-b.createdAt);
      lastItemsCache = items.slice(-VISIBLE_MAX);

      const plain = lastItemsCache.filter(m => m.role === "user" || m.role === "assistant");
      recentTurns = plain.slice(-8).map(m => ({ role:m.role, text:m.text }));

      renderLog();
    }, (err)=>console.error("[logs onValue]", err));
  }

  function renderLog() {
    const chatLog = document.getElementById("chat-log");
    chatLog.innerHTML = "";
    const visibleCount = showAll ? Math.min(lastItemsCache.length, VISIBLE_MAX) : Math.min(lastItemsCache.length, VISIBLE_MIN);
    const toShow = lastItemsCache.slice(-visibleCount);

    for (const m of toShow) {
      const who = m.role === "user" ? "ğŸ§â€â™‚ï¸" : m.role === "assistant" ? "ğŸ§ " : "â„¹ï¸";
      const div = document.createElement("div");
      div.className = "msg" + (m.role === "system" ? " system" : "");
      div.dataset.id = m.id;

      // å‰Šé™¤ãƒœã‚¿ãƒ³
      const del = document.createElement("button");
      del.className = "del-btn";
      del.title = "ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤";
      del.textContent = "ğŸ—‘ï¸";
      del.addEventListener("click", () => deleteLog(m.id));

      const span = document.createElement("span");
      span.textContent = `${who}ï¼š`;

      const textNode = document.createTextNode(m.text);

      div.appendChild(del);
      div.appendChild(span);
      div.appendChild(textNode);
      chatLog.appendChild(div);
    }

    document.getElementById("visibleHint").textContent =
      `è¡¨ç¤º: æœ€æ–°${visibleCount}ä»¶ï¼ˆå…¨${lastItemsCache.length}ä»¶ä¸­ï¼‰`;
    document.getElementById("toggleView").textContent =
      showAll ? "é–‰ã˜ã‚‹ï¼ˆ10ä»¶ã«ã™ã‚‹ï¼‰" : "ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆæœ€å¤§50ä»¶ï¼‰";
  }

  // ===== è¡¨ç¤ºç”¨ï¼šãƒšãƒƒãƒˆæƒ…å ±ã®æ–‡å­—åˆ— =====
  function toDisplayLine(p) {
    const parts = [];
    parts.push(`åå‰: ${p.name ?? "æœªç™»éŒ²"}`);
    parts.push(`ç¨®é¡: ${p.species ?? p.type ?? "æœªç™»éŒ²"}`);
    parts.push(`èª•ç”Ÿæ—¥: ${p.birthday ?? "æœªç™»éŒ²"}`);
    parts.push(`æ€§åˆ¥: ${p.gender ?? "æœªç™»éŒ²"}`);
    parts.push(`å¹´é½¢: ${p.age ?? "æœªç™»éŒ²"}`);
    parts.push(`å¥½ããªã‚‚ã®: ${p.favorite ?? "æœªç™»éŒ²"}`);
    parts.push(`ä½“é‡: ${p.weight ?? "æœªç™»éŒ²"}`);

    if (p.walk) {
      parts.push(`æ•£æ­©ã®é »åº¦: ${p.walk}`);
    } else {
      const walkKeys = Object.keys(p).filter(k => /^walk/i.test(k));
      if (walkKeys.length) {
        for (const k of walkKeys) parts.push(`æ•£æ­©ã®é »åº¦ï¼ˆ${k}ï¼‰: ${p[k]}`);
      } else {
        parts.push(`æ•£æ­©ã®é »åº¦: æœªç™»éŒ²`);
      }
    }
    if (p.meal) {
      parts.push(`ã”é£¯ã®é »åº¦: ${p.meal}`);
    } else {
      const mealKeys = Object.keys(p).filter(k => /^meal/i.test(k));
      if (mealKeys.length) {
        for (const k of mealKeys) parts.push(`ã”é£¯ï¼ˆ${k}ï¼‰: ${p[k]}`);
      } else {
        parts.push(`ã”é£¯ã®é »åº¦: æœªç™»éŒ²`);
      }
    }

    parts.push(`æ€§æ ¼: ${p.personality ?? "æœªç™»éŒ²"}`);
    parts.push(`ãã®ä»–: ${p.other ?? "æœªç™»éŒ²"}`);
    return parts.join("ã€");
  }

  // ===== ãƒšãƒƒãƒˆæƒ…å ± è³¼èª­ =====
  function startPetsSubscription() {
    const petsRef = ref(db, `users/${user.uid}/pets`);
    onValue(petsRef, (snapshot) => {
      petsMap = {};
      if (!snapshot.exists()) {
        petInfoText = "ï¼ˆãƒšãƒƒãƒˆæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰";
      } else {
        snapshot.forEach((child) => { petsMap[child.key] = child.val(); });
        const lines = Object.values(petsMap).map(p => toDisplayLine(p));
        petInfoText = lines.join("\n");
      }
    });
  }

  // ===== ãƒªã‚¹ãƒˆç³»ãƒãƒ¼ã‚¸ï¼ˆfavorite ãªã©ï¼‰ =====
  function mergeListLike(existing, incoming) {
    const toArray = (v) => {
      if (Array.isArray(v)) return v;
      if (v === undefined || v === null) return [];
      return String(v).split(/[ã€ï¼Œ,ï¼\/ãƒ»;ï¼›~\s]+/).map(s=>s.trim()).filter(Boolean);
    };
    const ex = toArray(existing), inc = toArray(incoming);
    const norm = (s)=>s.replace(/\s+/g,"").toLowerCase();
    const seen = new Set(ex.map(norm));
    const merged = [...ex];
    for (const x of inc) { const k = norm(x); if (!seen.has(k)) { seen.add(k); merged.push(x); } }
    return merged.join("ã€");
  }

  // ===== ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ­£è¦åŒ–ï¼ˆåŸºæœ¬ã¯ãã®ã¾ã¾ä¿å­˜ï¼‰ =====
  function normalizeFields(updateFields, currentPet) {
    const out = {};
    const f = { ...updateFields };
    const mapDirect = { favourite:"favorite", favorites:"favorite", likes:"favorite", weightKg:"weight", weightkg:"weight" };

    for (const [rawKey, val] of Object.entries(f)) {
      const key = mapDirect[rawKey] || rawKey;
      if (key === "favorite") {
        out.favorite = mergeListLike(currentPet?.favorite, val);
      } else {
        out[key] = val; // ãã®ã¾ã¾ä¸Šæ›¸ã
      }
    }
    return out;
  }

  // ===== UPDATE æŠ½å‡º â†’ é©ç”¨ =====
  function extractUpdateFromText(text) {
    const m = text.match(/UPDATE:\s*(\{[\s\S]*\})\s*$/);
    if (!m) return null;
    try {
      const obj = JSON.parse(m[1]);
      if (!obj || typeof obj !== "object" || !obj.fields) return null;
      return obj;
    } catch { return null; }
  }

  async function applyUpdate(updateObj) {
    if (!user || !updateObj?.fields) return;

    let targetId = updateObj.petId || null;
    if (!targetId && updateObj.petName) {
      targetId = Object.entries(petsMap).find(([id,p]) => p.name === updateObj.petName)?.[0] || null;
    }
    if (!targetId) targetId = Object.keys(petsMap)[0] || null;
    if (!targetId) return;

    const current = petsMap[targetId] || {};
    const fields = normalizeFields(updateObj.fields, current);
    if (!Object.keys(fields).length) return;

    await update(ref(db, `users/${user.uid}/pets/${targetId}`), fields);
    petsMap[targetId] = { ...current, ...fields }; // ãƒ­ãƒ¼ã‚«ãƒ«å³æ™‚åæ˜ 

    const petName = petsMap[targetId]?.name ?? "ä¸æ˜ãªãƒšãƒƒãƒˆ";
    const updates = Object.entries(fields).map(([k,v]) => `${k} â†’ ã€Œ${v}ã€`).join("ã€");
    addSystemLog(`ğŸ“˜ ${petName} ã®æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼š${updates}`);
  }

  // ===== é€ä¿¡ =====
  document.getElementById("send").addEventListener("click", async () => {
    const input = document.getElementById("message");
    const userMessage = input.value.trim();
    if (!userMessage) return;

    addLog("ğŸ§â€â™‚ï¸", userMessage);
    input.value = "";
    await saveLog("user", userMessage);

    const guard = `
ã‚ãªãŸã¯ãƒšãƒƒãƒˆã‚±ã‚¢ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
- ç™»éŒ²ã•ã‚Œã¦ã„ãªã„æƒ…å ±ã¯ä¸€èˆ¬è«–ã‚’ç¹”ã‚Šäº¤ãœã¦æ¨æ¸¬ã§å›ç­”ã™ã‚‹ã‹ã€å›ç­”ã‚’ã§ããªã„æ—¨ã‚’ä¼ãˆã‚‹ã€‚
- æ¨æ¸¬ã¯ã€Œæ¨æ¸¬ã§ã™ã€ã¨æ˜ç¤ºã—ã¦æ–­å®šã—ãªã„ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°ã—ã„äº‹å®Ÿã‚’è¿°ã¹ãŸå ´åˆã¯ã€è¿”ç­”ã®æœ€å¾Œã«
  UPDATE: {"petName":"ï¼ˆå¯¾è±¡åï¼‰","fields":{"favorite":"ã‚«ãƒ‹"}}
  ã®å½¢å¼ã§1è¡Œã ã‘å‡ºåŠ›ã™ã‚‹ã€‚`.trim();

    const fullPrompt = `
${guard}

ã€ç™»éŒ²ãƒšãƒƒãƒˆæƒ…å ±ã€‘
${petInfoText}

ã€ä¼šè©±å±¥æ­´ã€‘
${buildHistoryText()}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã€‘
${userMessage}
`.trim();

    try {
      const API_URL = "https://petals-backend.onrender.com/chat";


      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: fullPrompt }),
      });

      const data = await res.json();
      const reply = data.reply ?? JSON.stringify(data);

      // 1) UPDATE é©ç”¨ï¼ˆdata.update å„ªå…ˆã€ãªã‘ã‚Œã°æœ¬æ–‡ã®æœ«å°¾ã‹ã‚‰æŠ½å‡ºï¼‰
      const upd = data.update || extractUpdateFromText(reply);
      if (upd) await applyUpdate(upd);

      // 2) ç”»é¢ï¼†ä¿å­˜ç”¨ã¯ UPDATE è¡Œã‚’æ¶ˆã—ãŸãƒ†ã‚­ã‚¹ãƒˆã«ã™ã‚‹
      const visibleReply = stripUpdateFromText(reply);

      addLog("ğŸ§ ", visibleReply);
      await saveLog("assistant", visibleReply);

      renderLog();
    } catch (err) {
      console.error("ã‚¨ãƒ©ãƒ¼:", err);
      addLog("âš ï¸", "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      await saveLog("system", `error: ${String(err)}`);
      renderLog();
    }
    
  function addLog(who, text) {
    const log = document.getElementById("chat-log");
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<button class="del-btn" title="ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤">ğŸ—‘ï¸</button><span>${who}ï¼š</span>${text}`;
    log.appendChild(div);
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }
  function addSystemLog(text) {
    const log = document.getElementById("chat-log");
    const div = document.createElement("div");
    div.className = "msg system";
    div.textContent = text;
    log.appendChild(div);
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  // ===== è¡¨ç¤ºåˆ‡æ›¿ / å…¨å‰Šé™¤ãƒœã‚¿ãƒ³ =====
  document.getElementById("toggleView").addEventListener("click", () => {
    showAll = !showAll;
    renderLog();
  });
  document.getElementById("clearLogs").addEventListener("click", clearAllLogs);

  // ğŸ”¹ ã“ã‚ŒãŒæŠœã‘ã¦ã„ãŸã®ãŒé€ä¿¡ä¸å…·åˆã®åŸå› 
  function buildHistoryText() {
    if (!recentTurns.length) return "ï¼ˆç›´è¿‘ã®ä¼šè©±å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰";
    return recentTurns.map(m => (m.role === "user" ? "ãƒ¦ãƒ¼ã‚¶ãƒ¼" : "ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ") + ": " + m.text).join("\n");
  }

  
  // ===== èªè¨¼å¾Œ =====
  onAuthStateChanged(auth, (_user) => {
    if (_user) {
      user = _user;
      document.getElementById("status").textContent = `ğŸ¾ ã‚ˆã†ã“ã ${user.email} ã•ã‚“`;
      subscribeLogs();
      startPetsSubscription();
    } else {
      document.getElementById("status").textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚";
    }
  });
</script>
</body>
</html>
